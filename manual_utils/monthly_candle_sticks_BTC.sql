/****** 
First Halving: November 28, 2012
Second Halving: July 9, 2016
Third Halving: May 11, 2020
Fourth Halving: Apr 19, 2024
******/

drop table if exists #btc_mo_dy
drop table if exists #btc_mo_maxmin
drop table if exists #btc_mo_open
drop table if exists #btc_mo_close

-- Get the first day of each month data
SELECT concat(FORMAT([Date], 'yyyy-MM'), '-01') as [YearMoFst], FORMAT([Date], 'yyyy-MM-dd') as [YearMoDy], [Open_Price_USD],
	ROW_NUMBER() OVER (PARTITION BY FORMAT([Date], 'yyyy-MM') ORDER BY [Date]) AS RowNum,
	ROW_NUMBER() OVER (PARTITION BY FORMAT([Date], 'yyyy-MM') ORDER BY [Date] desc) AS InvRowNum
into #btc_mo_dy
FROM [cda].[dbo].[CryptoDaily]
where Crypto = 'BTC' and Date >= '2013-05-01 00:00:00.0000000 +00:00'

select [YearMoFst], max([Open_Price_USD]) as [High], min([Open_Price_USD]) as [Low]
into #btc_mo_maxmin
from #btc_mo_dy
group by [YearMoFst]

select [YearMoFst], [Open_Price_USD] as [Open]
into #btc_mo_open
from #btc_mo_dy
where RowNum = 1

select [YearMoFst], [Open_Price_USD] as [Close]
into #btc_mo_close
from #btc_mo_dy
where InvRowNum = 1

--drop table Candle_mon_BTC

select cast(m.[YearMoFst] as datetime) as FstMoDate, o.[Open], m.[High], m.[Low], c.[Close]
into Candle_mon_BTC
from #btc_mo_maxmin m
left join #btc_mo_open o on m.YearMoFst = o.YearMoFst
left join #btc_mo_close c on m.YearMoFst = c.YearMoFst

/*

  insert into Candle_mon_BTC ([FstMoDate], [Open], [High], [Low], [Close])
  values
  ('2024-01-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-02-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-03-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-04-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-05-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-06-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-07-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-08-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-09-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-10-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-11-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2024-12-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-01-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-02-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-03-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-04-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-05-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-06-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-07-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-08-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-09-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-10-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-11-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2025-12-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-01-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-02-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-03-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-04-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-05-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-06-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-07-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-08-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-09-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-10-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-11-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47),
  ('2026-12-01 00:00:00.000', 37711.82, 44202.18, 37711.82, 43418.47);
  */
